{%- capture vectorize_input -%}
  {"thought_id":"{{ data.metadata.thought_id }}","text":"{{ data.query }}"}
{%- endcapture -%}
{%- assign limit_value = data.limit | default: 5 | at_most: 50 -%}
{%- assign num_candidates_value = limit_value | times: 3 -%}
{
  "retriever": {
    "text_similarity_reranker": {
      "retriever": {
        "knn": {
          "field": "concepts.chunks.embedding",
          "query_vector": {{ vectorize_input | vectorize }},
          "k": {{ limit_value }},
          "num_candidates": {{ num_candidates_value }}
        }
      },
      "field": "preload.concept.content.merge",
      "inference_id": "voyageai-rerank",
      "inference_text": "{{ data.query }}",
      "min_score": 0.5,
      "rank_window_size": {{ limit_value }}{% if data.filter %},
      "filter": {{ data.filter | json }}{% endif %}
    }
  },
  "size": {{ limit_value }},
  "_source": {
    "includes": {{ data._source | json }},
    "excludes": ["*.embedding"]
  }
}
